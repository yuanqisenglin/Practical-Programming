# 使用指南

## 1. 环境准备

### 1.1 安装Python

确保系统已安装Python 3.8或更高版本。

### 1.2 安装依赖

```bash
pip install -r requirements.txt
```

### 1.3 配置LLM API（可选）

如果要使用真实的LLM API进行意图识别，需要设置API密钥：

**方式1：环境变量**
```bash
# Windows
set OPENAI_API_KEY=your_api_key_here

# Linux/Mac
export OPENAI_API_KEY=your_api_key_here
```

**方式2：命令行参数**
```bash
python src/main.py --script scripts/order_inquiry.dsl --api-key your_api_key_here
```

如果不配置API密钥，系统将使用模拟意图识别器（MockIntentAnalyzer）。

## 2. 运行程序

### 2.1 基本运行

```bash
# 订单查询场景
python src/main.py --script scripts/order_inquiry.dsl

# 退款申请场景
python src/main.py --script scripts/refund_application.dsl

# 物流跟踪场景
python src/main.py --script scripts/logistics_tracking.dsl

# 售后投诉场景
python src/main.py --script scripts/after_sales_complaint.dsl
```

### 2.2 使用模拟LLM

```bash
# 使用模拟LLM（推荐用于测试）
python src/main.py --script scripts/order_inquiry.dsl --mock
```

### 2.3 指定用户ID

```bash
python src/main.py --script scripts/order_inquiry.dsl --user-id user123
```

### 2.4 调试模式

系统支持调试模式，可以查看意图识别的详细过程，帮助诊断问题。

**启用意图识别调试模式：**

```bash
# Windows
set DEBUG_INTENT=true
python src/main.py --script scripts/order_inquiry.dsl

# Linux/Mac
export DEBUG_INTENT=true
python src/main.py --script scripts/order_inquiry.dsl
```

启用调试模式后，系统会在控制台输出意图识别的详细信息：
- 用户输入内容
- 识别到的意图名称
- 意图识别的置信度（0.0-1.0）
- 意图识别失败时的错误信息

**示例输出：**
```
[DEBUG] 用户输入: '返回主菜单' -> 识别意图: '返回主菜单' (置信度: 0.90)
[DEBUG] 用户输入: '退出去' -> 识别意图: '返回主菜单' (置信度: 0.85)
[DEBUG] 用户输入: '查看订单' -> 识别意图: '查看订单详情' (置信度: 0.88)
```

**关闭调试模式：**

```bash
# Windows
set DEBUG_INTENT=
# 或者不设置该环境变量

# Linux/Mac
unset DEBUG_INTENT
# 或者不设置该环境变量
```

**使用场景：**
- 调试意图识别问题
- 验证用户输入是否正确识别
- 检查意图识别的置信度
- 排查意图识别失败的原因

## 3. 编写DSL脚本

### 3.1 创建脚本文件

创建一个`.dsl`文件，例如`my_script.dsl`。

### 3.2 编写脚本内容

参考`scripts/`目录下的示例脚本，按照DSL语法规范编写。

### 3.3 运行自定义脚本

```bash
python src/main.py --script my_script.dsl
```

## 4. 运行测试

### 4.1 运行所有测试

```bash
python tests/run_tests.py
```

### 4.2 运行特定测试

```bash
python -m unittest tests.test_lexer
python -m unittest tests.test_parser
python -m unittest tests.test_interpreter
python -m unittest tests.test_intent_analyzer
```

## 5. 示例脚本说明

### 5.1 order_inquiry.dsl - 订单查询业务场景

专注于订单查询相关的功能，包括：
- 订单号验证
- 订单详情查询
- 物流信息查询
- 支持数字输入和意图识别

**运行方式**：
```bash
python src/main.py --script scripts/order_inquiry.dsl --mock
```

### 5.2 refund_application.dsl - 退款申请业务场景

专注于退款申请相关的功能，包括：
- 订单退款资格检查
- 退款原因选择
- 退款方式选择
- 退款确认和提交

**运行方式**：
```bash
python src/main.py --script scripts/refund_application.dsl --mock
```

### 5.3 logistics_tracking.dsl - 物流跟踪业务场景

专注于物流查询和跟踪相关的功能，包括：
- 订单号/快递单号查询
- 物流状态查询
- 详细物流轨迹查看

**运行方式**：
```bash
python src/main.py --script scripts/logistics_tracking.dsl --mock
```

### 5.4 after_sales_complaint.dsl - 售后投诉业务场景

专注于售后服务和投诉处理相关的功能，包括：
- 提交投诉
- 提交建议
- 查询投诉进度

**运行方式**：
```bash
python src/main.py --script scripts/after_sales_complaint.dsl --mock
```

## 6. 交互式使用

运行程序后，进入交互模式：

1. 系统会输出欢迎信息和提示
2. 输入您的需求（自然语言）
3. 系统会根据意图识别结果执行相应的流程
4. 按照提示继续交互
5. 输入`quit`或`exit`退出

**示例交互**:
```
系统: 欢迎使用智能客服系统！我是您的专属客服助手。
系统: 我可以帮助您处理以下业务：
系统: 1. 订单查询
系统: 2. 退款申请
系统: 3. 物流查询
系统: 4. 产品咨询
系统: 5. 投诉建议
系统: 请告诉我您需要什么帮助？

您: 我想查询订单

系统: 好的，我来帮您查询订单信息。
系统: 请输入您的订单号：

您: 1234567890

系统: 正在为您查询订单号为 1234567890 的订单信息...
```

## 7. 多线程支持

系统支持多用户并发访问。每个用户有独立的执行上下文，包括：
- 独立的变量表
- 独立的当前Step状态
- 线程安全的操作

在实际应用中，可以通过不同的`user_id`来区分不同用户。

## 8. 故障排除

### 8.1 脚本解析错误

如果遇到脚本解析错误，检查：
- 语法是否正确
- 大括号是否匹配
- 关键字拼写是否正确

### 8.2 意图识别失败

如果意图识别不准确：
- 检查LLM API配置是否正确
- 尝试使用更明确的用户输入
- 考虑使用模拟模式进行测试

### 8.3 变量未定义

如果变量未定义：
- 确保在使用变量前已通过`set`或`listen`设置
- 检查变量名拼写是否正确

## 9. 开发建议

1. **测试驱动**: 先编写测试用例，再实现功能
2. **模块化**: 将不同业务场景拆分到不同脚本
3. **文档化**: 为复杂逻辑添加注释
4. **版本控制**: 使用Git管理代码版本

